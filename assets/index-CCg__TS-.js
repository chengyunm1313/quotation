(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const c of n)if(c.type==="childList")for(const r of c.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&l(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const c={};return n.integrity&&(c.integrity=n.integrity),n.referrerPolicy&&(c.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?c.credentials="include":n.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function l(n){if(n.ep)return;n.ep=!0;const c=o(n);fetch(n.href,c)}})();function i(t){typeof t!="string"&&(t=String(t??"")),t=t.replace(/,/g,"").replace(/[^\d.-]/g,"");const e=parseFloat(t);return isNaN(e)?0:e}function s(t){return(+t||0).toLocaleString()}const S="admin",B="chengyun2024";function v(){new bootstrap.Modal(document.getElementById("loginModal")).show(),document.getElementById("username").value="",document.getElementById("password").value="",document.getElementById("loginError").classList.add("d-none")}function f(){const t=document.getElementById("username").value,e=document.getElementById("password").value;t===S&&e===B?(localStorage.setItem("quotationLoginInfo",JSON.stringify({isLoggedIn:!0,username:t,loginTime:new Date().toISOString()})),bootstrap.Modal.getInstance(document.getElementById("loginModal")).hide(),document.getElementById("logoutBtn").classList.remove("d-none")):document.getElementById("loginError").classList.remove("d-none")}function E(){confirm("確定要登出系統嗎？")&&(localStorage.removeItem("quotationLoginInfo"),v(),document.getElementById("logoutBtn").classList.add("d-none"))}function I(){const t=document.querySelector("#itemTable tbody"),e=document.createElement("tr");e.innerHTML=`
    <td class="text-center"><input type="checkbox" class="row-chk"></td>
    <td><input type="text" class="form-control form-control-sm item-name"></td>
    <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
    <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
    <td class="text-end fw-bold item-subtotal">0</td>
  `,t.appendChild(e),u(e),d()}function b(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{if(e.querySelector(".row-chk").checked){const o=e.cloneNode(!0);o.querySelector(".row-chk").checked=!1,t.appendChild(o),u(o)}}),d()}function q(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{e.querySelector(".row-chk").checked&&e.remove()}),t.querySelector("tr")||I(),d()}function x(t){const e=t.checked;document.querySelectorAll("#itemTable tbody .row-chk").forEach(o=>o.checked=e)}function u(t){const e=i(t.querySelector(".item-qty")?.value??0),o=i(t.querySelector(".item-price")?.value??0),l=i(t.querySelector(".item-discount")?.value??0),n=Math.max(e*o-l,0);return t.querySelector(".item-subtotal").textContent=s(n),n}function d(){const t=document.querySelectorAll("#itemTable tbody tr");let e=0;t.forEach(c=>e+=u(c));const o=i(document.getElementById("taxRate").value),l=e*(o/100),n=e+l;document.getElementById("subtotal").textContent="NT$ "+s(e),document.getElementById("tax").textContent="NT$ "+s(l),document.getElementById("total").textContent="NT$ "+s(n)}function L(t){const e=document.documentElement;let l=parseInt(getComputedStyle(e).getPropertyValue("--col-name-width")||"180",10)+t;l<100&&(l=100),l>400&&(l=400),e.style.setProperty("--col-name-width",l+"px");const n=document.getElementById("colWidthSlider");n&&(n.value=l)}function w(){return{quoteDate:document.getElementById("quoteDate").value,quoteNo:document.getElementById("quoteNo").value,eventName:document.getElementById("eventName").value,eventDate:document.getElementById("eventDate").value,eventTime:document.getElementById("eventTime").value,venue:document.getElementById("venue").value,account:document.getElementById("account").value,taxRate:document.getElementById("taxRate").value,paymentTerm:document.getElementById("paymentTerm").value,validDays:document.getElementById("validDays").value,clientCompany:document.getElementById("clientCompany").value,clientContact:document.getElementById("clientContact").value,clientPhone:document.getElementById("clientPhone").value,clientAddress:document.getElementById("clientAddress").value,clientFax:document.getElementById("clientFax").value,clientMobile:document.getElementById("clientMobile").value,clientEmail:document.getElementById("clientEmail").value,vendorCompany:document.getElementById("vendorCompany").value,vendorTax:document.getElementById("vendorTax").value,vendorContact:document.getElementById("vendorContact").value,vendorEmail:document.getElementById("vendorEmail").value,vendorPhone:document.getElementById("vendorPhone").value,vendorAddress:document.getElementById("vendorAddress").value,notes:document.getElementById("notes").value}}function h(t){if(t)for(const e of Object.keys(t)){const o=document.getElementById(e);o&&(o.value=t[e])}}function T(){const t=[];return document.querySelectorAll("#itemTable tbody tr").forEach(e=>{t.push({name:e.querySelector(".item-name").value,desc:e.querySelector(".item-desc").value,unit:e.querySelector(".item-unit").value,qty:e.querySelector(".item-qty").value,price:e.querySelector(".item-price").value,discount:e.querySelector(".item-discount").value})}),t}function m(t){const e=document.querySelector("#itemTable tbody");e.innerHTML="",(t||[]).forEach(o=>{const l=document.createElement("tr");l.innerHTML=`
      <td class="text-center"><input type="checkbox" class="row-chk"></td>
      <td><input type="text" class="form-control form-control-sm item-name" value="${o.name||""}"></td>
      <td><textarea class="form-control form-control-sm item-desc" rows="1">${o.desc||""}</textarea></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${o.unit||"組"}"></td>
      <td><input type="number" class="form-control form-control-sm item-qty" value="${o.qty||1}" min="1" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-price" value="${o.price||0}" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-discount" value="${o.discount||0}" inputmode="decimal"></td>
      <td class="text-end fw-bold item-subtotal">0</td>`,e.appendChild(l),u(l)}),d()}function C(){const t={meta:w(),items:T()};localStorage.setItem("quotationDraft",JSON.stringify(t)),alert("已暫存資料")}function N(){const t=localStorage.getItem("quotationDraft");if(!t){alert("無暫存資料");return}try{const e=JSON.parse(t);h(e.meta),m(e.items),alert("已載入暫存資料")}catch{alert("暫存資料格式不正確")}}function O(){confirm("確認清除暫存？")&&(localStorage.removeItem("quotationDraft"),alert("已清除暫存資料"))}function D(t){const e=t.target.files[0];if(!e)return;const o=new FileReader;o.onload=l=>{const n=l.target.result;if(e.name.endsWith(".json"))try{const c=JSON.parse(n);Array.isArray(c)?c.length?(m(c),alert("已匯入 JSON")):alert("JSON 內容無有效項目"):c&&Array.isArray(c.items)&&c.items.length?(h(c.meta||{}),m(c.items),alert("已匯入 JSON")):alert("JSON 內容無有效項目")}catch{alert("JSON 格式錯誤")}else e.name.endsWith(".csv")?A(n):alert("不支援的檔案類型")},o.readAsText(e),t.target.value=""}function A(t){const e=t.trim().split(/\r?\n/);if(e.length<2){alert("CSV 無資料");return}const o=e[0].split(","),l=[];for(let n=1;n<e.length;n++){const c=e[n].split(","),r={};o.forEach((a,y)=>r[a.trim()]=c[y]?c[y].trim():""),l.push({name:r.name||"",desc:r.desc||"",unit:r.unit||"",qty:r.qty||1,price:r.price||0,discount:r.discount||0})}l.length?(m(l),alert("已匯入 CSV")):alert("CSV 內容無有效項目，保留原表格")}function M(){document.getElementById("generatedAt").textContent=new Date().toLocaleString();const t=document.getElementById("notes"),e=document.getElementById("notesDisplay"),o=t.value.split(`
`).filter(l=>l.trim()!=="").map(l=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${l}</p>`).join("");e.innerHTML=o,e.style.position="static",e.style.display="block",e.style.width="100%",e.style.border="1px solid #dee2e6",e.style.borderRadius="0.375rem",e.style.padding="0.5rem",e.style.fontSize="0.875rem",e.style.backgroundColor="white",e.classList.remove("d-none"),t.classList.add("d-none"),setTimeout(()=>{const l=document.querySelector(".container-fluid"),n={margin:0,filename:(document.getElementById("quoteNo").value||"quotation")+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,scrollY:0,windowWidth:document.documentElement.offsetWidth,windowHeight:document.documentElement.offsetHeight,logging:!1,onclone:function(c){const r=c.getElementById("notes"),a=c.getElementById("notesDisplay");if(r&&a){const y=r.value.split(`
`).filter(g=>g.trim()!=="").map(g=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${g}</p>`).join("");a.innerHTML=y,a.style.position="static",a.style.display="block",a.style.width="100%",a.style.border="1px solid #dee2e6",a.style.borderRadius="0.375rem",a.style.padding="0.5rem",a.style.fontSize="0.875rem",a.style.backgroundColor="white",a.classList.remove("d-none"),r.classList.add("d-none")}}},jsPDF:{unit:"in",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all"]}};html2pdf().set(n).from(l).save().then(()=>{setTimeout(()=>{e.classList.add("d-none"),t.classList.remove("d-none"),e.style.position="",e.style.display="",e.style.width="",e.style.border="",e.style.borderRadius="",e.style.padding="",e.style.fontSize="",e.style.backgroundColor=""},1e3)})},100)}const p="quoteTemplates";localStorage.getItem(p)||localStorage.setItem(p,JSON.stringify([{name:"網站建置",desc:"五頁靜態官網",unit:"案",qty:1,price:3e4,discount:0},{name:"維護費",desc:"一年維護服務",unit:"年",qty:1,price:12e3,discount:0}]));function k(){const t=JSON.parse(localStorage.getItem(p)||"[]");if(!t.length){alert("尚未建立模板");return}m(t)}document.getElementById("itemTable").addEventListener("input",t=>{["item-qty","item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(u(t.target.closest("tr")),d())});document.getElementById("itemTable").addEventListener("blur",t=>{["item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(t.target.value=s(i(t.target.value)))},!0);document.getElementById("colWidthSlider").addEventListener("input",t=>{document.documentElement.style.setProperty("--col-name-width",t.target.value+"px")});document.getElementById("taxRate").addEventListener("input",d);document.addEventListener("DOMContentLoaded",()=>{document.documentElement.style.setProperty("--col-name-width","180px"),document.getElementById("generatedAt").textContent=new Date().toLocaleString(),d();const t=JSON.parse(localStorage.getItem("quotationLoginInfo")||"null");t&&t.isLoggedIn?document.getElementById("logoutBtn").classList.remove("d-none"):(document.getElementById("logoutBtn").classList.add("d-none"),v()),document.getElementById("loginBtn").addEventListener("click",f),document.getElementById("logoutBtn").addEventListener("click",E),document.getElementById("password").addEventListener("keypress",e=>{e.key==="Enter"&&f()})});Object.assign(window,{addRow:I,duplicateRow:b,deleteSelected:q,toggleAll:x,saveDraft:C,loadDraft:N,clearDraft:O,importFile:D,exportPDF:M,applyTemplate:k,adjustColWidth:L,login:f,logout:E,showLoginModal:v});
