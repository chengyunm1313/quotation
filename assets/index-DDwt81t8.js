(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&c(s)}).observe(document,{childList:!0,subtree:!0});function l(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(o){if(o.ep)return;o.ep=!0;const n=l(o);fetch(o.href,n)}})();function u(t){typeof t!="string"&&(t=String(t??"")),t=t.replace(/,/g,"").replace(/[^\d.-]/g,"");const e=parseFloat(t);return isNaN(e)?0:e}function y(t){return(+t||0).toLocaleString()}const w="chengyun2025";function E(){const t=document.getElementById("loginPage");t.style.display="flex",document.getElementById("loginPassword").value="",document.getElementById("loginError").classList.remove("show"),setTimeout(()=>{document.getElementById("loginPassword").focus()},100)}function h(){const t=document.getElementById("loginPage");t.style.display="none"}function p(){const t=document.getElementById("loginPassword").value,e=document.getElementById("loginError");t===w?(localStorage.setItem("quotationLoginInfo",JSON.stringify({isLoggedIn:!0,loginTime:new Date().toISOString()})),h(),document.getElementById("logoutBtn").classList.remove("d-none"),e.classList.remove("show")):(e.classList.add("show"),document.getElementById("loginPassword").value="",document.getElementById("loginPassword").focus(),setTimeout(()=>{e.classList.remove("show")},3e3))}function S(){confirm("確定要登出系統嗎？")&&(localStorage.removeItem("quotationLoginInfo"),E(),document.getElementById("logoutBtn").classList.add("d-none"))}function b(){const t=document.getElementById("loginPassword"),l=document.getElementById("passwordToggle").querySelector("i");t.type==="password"?(t.type="text",l.className="bi bi-eye-slash"):(t.type="password",l.className="bi bi-eye")}function B(){const t=document.querySelector("#itemTable tbody"),e=document.createElement("tr");e.innerHTML=`
    <td class="text-center"><input type="checkbox" class="row-chk"></td>
    <td><input type="text" class="form-control form-control-sm item-name"></td>
    <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
    <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
    <td class="text-end fw-bold item-subtotal">0</td>
  `,t.appendChild(e),f(e),m()}function T(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{if(e.querySelector(".row-chk").checked){const l=e.cloneNode(!0);l.querySelector(".row-chk").checked=!1,t.appendChild(l),f(l)}}),m()}function C(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{e.querySelector(".row-chk").checked&&e.remove()}),t.querySelector("tr")||B(),m()}function N(t){const e=t.checked;document.querySelectorAll("#itemTable tbody .row-chk").forEach(l=>l.checked=e)}function f(t){const e=u(t.querySelector(".item-qty")?.value??0),l=u(t.querySelector(".item-price")?.value??0),c=u(t.querySelector(".item-discount")?.value??0),o=Math.max(e*l-c,0);return t.querySelector(".item-subtotal").textContent=y(o),o}function m(){const t=document.querySelectorAll("#itemTable tbody tr");let e=0;t.forEach(n=>e+=f(n));const l=u(document.getElementById("taxRate").value),c=e*(l/100),o=e+c;document.getElementById("subtotal").textContent="NT$ "+y(e),document.getElementById("tax").textContent="NT$ "+y(c),document.getElementById("total").textContent="NT$ "+y(o)}function O(t){const e=document.documentElement;let c=parseInt(getComputedStyle(e).getPropertyValue("--col-name-width")||"180",10)+t;c<100&&(c=100),c>400&&(c=400),e.style.setProperty("--col-name-width",c+"px");const o=document.getElementById("colWidthSlider");o&&(o.value=c)}function q(){return{quoteDate:document.getElementById("quoteDate").value,quoteNo:document.getElementById("quoteNo").value,eventName:document.getElementById("eventName").value,eventDate:document.getElementById("eventDate").value,eventTime:document.getElementById("eventTime").value,venue:document.getElementById("venue").value,account:document.getElementById("account").value,taxRate:document.getElementById("taxRate").value,paymentTerm:document.getElementById("paymentTerm").value,validDays:document.getElementById("validDays").value,clientCompany:document.getElementById("clientCompany").value,clientTax:document.getElementById("clientTax").value,clientContact:document.getElementById("clientContact").value,clientPhone:document.getElementById("clientPhone").value,clientAddress:document.getElementById("clientAddress").value,clientFax:document.getElementById("clientFax").value,clientMobile:document.getElementById("clientMobile").value,clientEmail:document.getElementById("clientEmail").value,vendorCompany:document.getElementById("vendorCompany").value,vendorTax:document.getElementById("vendorTax").value,vendorContact:document.getElementById("vendorContact").value,vendorEmail:document.getElementById("vendorEmail").value,vendorPhone:document.getElementById("vendorPhone").value,vendorAddress:document.getElementById("vendorAddress").value,notes:document.getElementById("notes").value}}function L(t){if(t)for(const e of Object.keys(t)){const l=document.getElementById(e);l&&(l.value=t[e])}}function I(){const t=[];return document.querySelectorAll("#itemTable tbody tr").forEach(e=>{t.push({name:e.querySelector(".item-name").value,desc:e.querySelector(".item-desc").value,unit:e.querySelector(".item-unit").value,qty:e.querySelector(".item-qty").value,price:e.querySelector(".item-price").value,discount:e.querySelector(".item-discount").value})}),t}function g(t){const e=document.querySelector("#itemTable tbody");e.innerHTML="",(t||[]).forEach(l=>{const c=document.createElement("tr");c.innerHTML=`
      <td class="text-center"><input type="checkbox" class="row-chk"></td>
      <td><input type="text" class="form-control form-control-sm item-name" value="${l.name||""}"></td>
      <td><textarea class="form-control form-control-sm item-desc" rows="1">${l.desc||""}</textarea></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${l.unit||"組"}"></td>
      <td><input type="number" class="form-control form-control-sm item-qty" value="${l.qty||1}" min="1" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-price" value="${l.price||0}" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-discount" value="${l.discount||0}" inputmode="decimal"></td>
      <td class="text-end fw-bold item-subtotal">0</td>`,e.appendChild(c),f(c)}),m()}function P(){const t={meta:q(),items:I()};localStorage.setItem("quotationDraft",JSON.stringify(t)),alert("已暫存資料")}function k(){const t=localStorage.getItem("quotationDraft");if(!t){alert("無暫存資料");return}try{const e=JSON.parse(t);L(e.meta),g(e.items),alert("已載入暫存資料")}catch{alert("暫存資料格式不正確")}}function D(){confirm("確認清除暫存？")&&(localStorage.removeItem("quotationDraft"),alert("已清除暫存資料"))}function R(){const t={meta:q(),items:I()},e=JSON.stringify(t,null,2),l=new Blob([e],{type:"application/json"}),c=URL.createObjectURL(l),o=document.createElement("a");o.href=c,o.download=(document.getElementById("quoteNo").value||"quotation")+".json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(c)}function A(){const t=I();if(!t.length){alert("無項目資料可匯出");return}const e=["name","desc","unit","qty","price","discount"],l=[e.join(","),...t.map(s=>e.map(r=>`"${(s[r]||"").toString().replace(/"/g,'""')}"`).join(","))].join(`
`),c=new Blob(["\uFEFF"+l],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(c),n=document.createElement("a");n.href=o,n.download=(document.getElementById("quoteNo").value||"quotation")+"_items.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o)}function j(t){const e=t.target.files[0];if(!e)return;const l=new FileReader;l.onload=c=>{const o=c.target.result;if(e.name.endsWith(".json"))try{const n=JSON.parse(o);Array.isArray(n)?n.length?(g(n),alert("已匯入 JSON")):alert("JSON 內容無有效項目"):n&&Array.isArray(n.items)&&n.items.length?(L(n.meta||{}),g(n.items),alert("已匯入 JSON")):alert("JSON 內容無有效項目")}catch{alert("JSON 格式錯誤")}else e.name.endsWith(".csv")?J(o):alert("不支援的檔案類型")},l.readAsText(e),t.target.value=""}function J(t){const e=t.trim().split(/\r?\n/);if(e.length<2){alert("CSV 無資料");return}function l(n){const s=[];let r="",d=!1;for(let i=0;i<n.length;i++){const a=n[i],x=n[i+1];a==='"'?d&&x==='"'?(r+='"',i++):d=!d:a===","&&!d?(s.push(r.trim()),r=""):r+=a}return s.push(r.trim()),s}const c=l(e[0]).map(n=>n.trim()),o=[];for(let n=1;n<e.length;n++){if(!e[n].trim())continue;const s=l(e[n]),r={};c.forEach((d,i)=>{let a=s[i]?s[i].trim():"";a.startsWith('"')&&a.endsWith('"')&&(a=a.slice(1,-1)),r[d]=a}),o.push({name:r.name||"",desc:r.desc||"",unit:r.unit||"組",qty:r.qty||1,price:r.price||0,discount:r.discount||0})}o.length?(g(o),alert("已匯入 CSV")):alert("CSV 內容無有效項目，保留原表格")}function M(){document.getElementById("generatedAt").textContent=new Date().toLocaleString();const t=document.getElementById("notes"),e=document.getElementById("notesDisplay"),l=t.value.split(`
`).filter(c=>c.trim()!=="").map(c=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${c}</p>`).join("");e.innerHTML=l,e.style.position="static",e.style.display="block",e.style.width="100%",e.style.border="1px solid #dee2e6",e.style.borderRadius="0.375rem",e.style.padding="0.5rem",e.style.fontSize="0.875rem",e.style.backgroundColor="white",e.classList.remove("d-none"),t.classList.add("d-none"),setTimeout(()=>{const c=document.querySelector(".container-fluid"),o={margin:0,filename:(document.getElementById("quoteNo").value||"quotation")+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,scrollY:0,windowWidth:document.documentElement.offsetWidth,windowHeight:document.documentElement.offsetHeight,logging:!1,onclone:function(n){const s=n.getElementById("notes"),r=n.getElementById("notesDisplay");if(s&&r){const d=s.value.split(`
`).filter(i=>i.trim()!=="").map(i=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${i}</p>`).join("");r.innerHTML=d,r.style.position="static",r.style.display="block",r.style.width="100%",r.style.border="1px solid #dee2e6",r.style.borderRadius="0.375rem",r.style.padding="0.5rem",r.style.fontSize="0.875rem",r.style.backgroundColor="white",r.classList.remove("d-none"),s.classList.add("d-none")}}},jsPDF:{unit:"in",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all"]}};html2pdf().set(o).from(c).save().then(()=>{setTimeout(()=>{e.classList.add("d-none"),t.classList.remove("d-none"),e.style.position="",e.style.display="",e.style.width="",e.style.border="",e.style.borderRadius="",e.style.padding="",e.style.fontSize="",e.style.backgroundColor=""},1e3)})},100)}const v="quoteTemplates";localStorage.getItem(v)||localStorage.setItem(v,JSON.stringify([{name:"網站建置",desc:"五頁靜態官網",unit:"案",qty:1,price:3e4,discount:0},{name:"維護費",desc:"一年維護服務",unit:"年",qty:1,price:12e3,discount:0}]));function F(){const t=JSON.parse(localStorage.getItem(v)||"[]");if(!t.length){alert("尚未建立模板");return}g(t)}document.getElementById("itemTable").addEventListener("input",t=>{["item-qty","item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(f(t.target.closest("tr")),m())});document.getElementById("itemTable").addEventListener("blur",t=>{["item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(t.target.value=y(u(t.target.value)))},!0);document.getElementById("colWidthSlider").addEventListener("input",t=>{document.documentElement.style.setProperty("--col-name-width",t.target.value+"px")});document.getElementById("taxRate").addEventListener("input",m);document.addEventListener("DOMContentLoaded",()=>{document.documentElement.style.setProperty("--col-name-width","180px"),document.getElementById("generatedAt").textContent=new Date().toLocaleString(),m();const t=JSON.parse(localStorage.getItem("quotationLoginInfo")||"null");t&&t.isLoggedIn?(document.getElementById("logoutBtn").classList.remove("d-none"),h()):(document.getElementById("logoutBtn").classList.add("d-none"),E()),document.getElementById("loginBtn").addEventListener("click",p),document.getElementById("logoutBtn").addEventListener("click",S),document.getElementById("passwordToggle").addEventListener("click",b),document.getElementById("loginPassword").addEventListener("keypress",e=>{e.key==="Enter"&&p()})});Object.assign(window,{addRow:B,duplicateRow:T,deleteSelected:C,toggleAll:N,saveDraft:P,loadDraft:k,clearDraft:D,importFile:j,exportJSON:R,exportCSV:A,exportPDF:M,applyTemplate:F,adjustColWidth:O,login:p,logout:S,showLoginPage:E,hideLoginPage:h,togglePassword:b});
