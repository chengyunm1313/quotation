(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const r of c.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&l(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function l(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();function i(t){typeof t!="string"&&(t=String(t??"")),t=t.replace(/,/g,"").replace(/[^\d.-]/g,"");const e=parseFloat(t);return isNaN(e)?0:e}function d(t){return(+t||0).toLocaleString()}const L="chengyun2025";function v(){const t=document.getElementById("loginPage");t.style.display="flex",document.getElementById("loginPassword").value="",document.getElementById("loginError").classList.remove("show"),setTimeout(()=>{document.getElementById("loginPassword").focus()},100)}function E(){const t=document.getElementById("loginPage");t.style.display="none"}function p(){const t=document.getElementById("loginPassword").value,e=document.getElementById("loginError");t===L?(localStorage.setItem("quotationLoginInfo",JSON.stringify({isLoggedIn:!0,loginTime:new Date().toISOString()})),E(),document.getElementById("logoutBtn").classList.remove("d-none"),e.classList.remove("show")):(e.classList.add("show"),document.getElementById("loginPassword").value="",document.getElementById("loginPassword").focus(),setTimeout(()=>{e.classList.remove("show")},3e3))}function I(){confirm("確定要登出系統嗎？")&&(localStorage.removeItem("quotationLoginInfo"),v(),document.getElementById("logoutBtn").classList.add("d-none"))}function S(){const t=document.getElementById("loginPassword"),n=document.getElementById("passwordToggle").querySelector("i");t.type==="password"?(t.type="text",n.className="bi bi-eye-slash"):(t.type="password",n.className="bi bi-eye")}function b(){const t=document.querySelector("#itemTable tbody"),e=document.createElement("tr");e.innerHTML=`
    <td class="text-center"><input type="checkbox" class="row-chk"></td>
    <td><input type="text" class="form-control form-control-sm item-name"></td>
    <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
    <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
    <td class="text-end fw-bold item-subtotal">0</td>
  `,t.appendChild(e),u(e),a()}function w(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{if(e.querySelector(".row-chk").checked){const n=e.cloneNode(!0);n.querySelector(".row-chk").checked=!1,t.appendChild(n),u(n)}}),a()}function x(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{e.querySelector(".row-chk").checked&&e.remove()}),t.querySelector("tr")||b(),a()}function T(t){const e=t.checked;document.querySelectorAll("#itemTable tbody .row-chk").forEach(n=>n.checked=e)}function u(t){const e=i(t.querySelector(".item-qty")?.value??0),n=i(t.querySelector(".item-price")?.value??0),l=i(t.querySelector(".item-discount")?.value??0),o=Math.max(e*n-l,0);return t.querySelector(".item-subtotal").textContent=d(o),o}function a(){const t=document.querySelectorAll("#itemTable tbody tr");let e=0;t.forEach(c=>e+=u(c));const n=i(document.getElementById("taxRate").value),l=e*(n/100),o=e+l;document.getElementById("subtotal").textContent="NT$ "+d(e),document.getElementById("tax").textContent="NT$ "+d(l),document.getElementById("total").textContent="NT$ "+d(o)}function C(t){const e=document.documentElement;let l=parseInt(getComputedStyle(e).getPropertyValue("--col-name-width")||"180",10)+t;l<100&&(l=100),l>400&&(l=400),e.style.setProperty("--col-name-width",l+"px");const o=document.getElementById("colWidthSlider");o&&(o.value=l)}function B(){return{quoteDate:document.getElementById("quoteDate").value,quoteNo:document.getElementById("quoteNo").value,eventName:document.getElementById("eventName").value,eventDate:document.getElementById("eventDate").value,eventTime:document.getElementById("eventTime").value,venue:document.getElementById("venue").value,account:document.getElementById("account").value,taxRate:document.getElementById("taxRate").value,paymentTerm:document.getElementById("paymentTerm").value,validDays:document.getElementById("validDays").value,clientCompany:document.getElementById("clientCompany").value,clientTax:document.getElementById("clientTax").value,clientContact:document.getElementById("clientContact").value,clientPhone:document.getElementById("clientPhone").value,clientAddress:document.getElementById("clientAddress").value,clientFax:document.getElementById("clientFax").value,clientMobile:document.getElementById("clientMobile").value,clientEmail:document.getElementById("clientEmail").value,vendorCompany:document.getElementById("vendorCompany").value,vendorTax:document.getElementById("vendorTax").value,vendorContact:document.getElementById("vendorContact").value,vendorEmail:document.getElementById("vendorEmail").value,vendorPhone:document.getElementById("vendorPhone").value,vendorAddress:document.getElementById("vendorAddress").value,notes:document.getElementById("notes").value}}function q(t){if(t)for(const e of Object.keys(t)){const n=document.getElementById(e);n&&(n.value=t[e])}}function h(){const t=[];return document.querySelectorAll("#itemTable tbody tr").forEach(e=>{t.push({name:e.querySelector(".item-name").value,desc:e.querySelector(".item-desc").value,unit:e.querySelector(".item-unit").value,qty:e.querySelector(".item-qty").value,price:e.querySelector(".item-price").value,discount:e.querySelector(".item-discount").value})}),t}function m(t){const e=document.querySelector("#itemTable tbody");e.innerHTML="",(t||[]).forEach(n=>{const l=document.createElement("tr");l.innerHTML=`
      <td class="text-center"><input type="checkbox" class="row-chk"></td>
      <td><input type="text" class="form-control form-control-sm item-name" value="${n.name||""}"></td>
      <td><textarea class="form-control form-control-sm item-desc" rows="1">${n.desc||""}</textarea></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${n.unit||"組"}"></td>
      <td><input type="number" class="form-control form-control-sm item-qty" value="${n.qty||1}" min="1" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-price" value="${n.price||0}" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-discount" value="${n.discount||0}" inputmode="decimal"></td>
      <td class="text-end fw-bold item-subtotal">0</td>`,e.appendChild(l),u(l)}),a()}function N(){const t={meta:B(),items:h()};localStorage.setItem("quotationDraft",JSON.stringify(t)),alert("已暫存資料")}function O(){const t=localStorage.getItem("quotationDraft");if(!t){alert("無暫存資料");return}try{const e=JSON.parse(t);q(e.meta),m(e.items),alert("已載入暫存資料")}catch{alert("暫存資料格式不正確")}}function P(){confirm("確認清除暫存？")&&(localStorage.removeItem("quotationDraft"),alert("已清除暫存資料"))}function k(){const t={meta:B(),items:h()},e=JSON.stringify(t,null,2),n=new Blob([e],{type:"application/json"}),l=URL.createObjectURL(n),o=document.createElement("a");o.href=l,o.download=(document.getElementById("quoteNo").value||"quotation")+".json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(l)}function D(){const t=h();if(!t.length){alert("無項目資料可匯出");return}const e=["name","desc","unit","qty","price","discount"],n=[e.join(","),...t.map(r=>e.map(s=>`"${(r[s]||"").toString().replace(/"/g,'""')}"`).join(","))].join(`
`),l=new Blob(["\uFEFF"+n],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(l),c=document.createElement("a");c.href=o,c.download=(document.getElementById("quoteNo").value||"quotation")+"_items.csv",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(o)}function R(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=l=>{const o=l.target.result;if(e.name.endsWith(".json"))try{const c=JSON.parse(o);Array.isArray(c)?c.length?(m(c),alert("已匯入 JSON")):alert("JSON 內容無有效項目"):c&&Array.isArray(c.items)&&c.items.length?(q(c.meta||{}),m(c.items),alert("已匯入 JSON")):alert("JSON 內容無有效項目")}catch{alert("JSON 格式錯誤")}else e.name.endsWith(".csv")?A(o):alert("不支援的檔案類型")},n.readAsText(e),t.target.value=""}function A(t){const e=t.trim().split(/\r?\n/);if(e.length<2){alert("CSV 無資料");return}const n=e[0].split(","),l=[];for(let o=1;o<e.length;o++){const c=e[o].split(","),r={};n.forEach((s,y)=>r[s.trim()]=c[y]?c[y].trim():""),l.push({name:r.name||"",desc:r.desc||"",unit:r.unit||"",qty:r.qty||1,price:r.price||0,discount:r.discount||0})}l.length?(m(l),alert("已匯入 CSV")):alert("CSV 內容無有效項目，保留原表格")}function j(){document.getElementById("generatedAt").textContent=new Date().toLocaleString();const t=document.getElementById("notes"),e=document.getElementById("notesDisplay"),n=t.value.split(`
`).filter(l=>l.trim()!=="").map(l=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${l}</p>`).join("");e.innerHTML=n,e.style.position="static",e.style.display="block",e.style.width="100%",e.style.border="1px solid #dee2e6",e.style.borderRadius="0.375rem",e.style.padding="0.5rem",e.style.fontSize="0.875rem",e.style.backgroundColor="white",e.classList.remove("d-none"),t.classList.add("d-none"),setTimeout(()=>{const l=document.querySelector(".container-fluid"),o={margin:0,filename:(document.getElementById("quoteNo").value||"quotation")+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,scrollY:0,windowWidth:document.documentElement.offsetWidth,windowHeight:document.documentElement.offsetHeight,logging:!1,onclone:function(c){const r=c.getElementById("notes"),s=c.getElementById("notesDisplay");if(r&&s){const y=r.value.split(`
`).filter(g=>g.trim()!=="").map(g=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${g}</p>`).join("");s.innerHTML=y,s.style.position="static",s.style.display="block",s.style.width="100%",s.style.border="1px solid #dee2e6",s.style.borderRadius="0.375rem",s.style.padding="0.5rem",s.style.fontSize="0.875rem",s.style.backgroundColor="white",s.classList.remove("d-none"),r.classList.add("d-none")}}},jsPDF:{unit:"in",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all"]}};html2pdf().set(o).from(l).save().then(()=>{setTimeout(()=>{e.classList.add("d-none"),t.classList.remove("d-none"),e.style.position="",e.style.display="",e.style.width="",e.style.border="",e.style.borderRadius="",e.style.padding="",e.style.fontSize="",e.style.backgroundColor=""},1e3)})},100)}const f="quoteTemplates";localStorage.getItem(f)||localStorage.setItem(f,JSON.stringify([{name:"網站建置",desc:"五頁靜態官網",unit:"案",qty:1,price:3e4,discount:0},{name:"維護費",desc:"一年維護服務",unit:"年",qty:1,price:12e3,discount:0}]));function J(){const t=JSON.parse(localStorage.getItem(f)||"[]");if(!t.length){alert("尚未建立模板");return}m(t)}document.getElementById("itemTable").addEventListener("input",t=>{["item-qty","item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(u(t.target.closest("tr")),a())});document.getElementById("itemTable").addEventListener("blur",t=>{["item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(t.target.value=d(i(t.target.value)))},!0);document.getElementById("colWidthSlider").addEventListener("input",t=>{document.documentElement.style.setProperty("--col-name-width",t.target.value+"px")});document.getElementById("taxRate").addEventListener("input",a);document.addEventListener("DOMContentLoaded",()=>{document.documentElement.style.setProperty("--col-name-width","180px"),document.getElementById("generatedAt").textContent=new Date().toLocaleString(),a();const t=JSON.parse(localStorage.getItem("quotationLoginInfo")||"null");t&&t.isLoggedIn?(document.getElementById("logoutBtn").classList.remove("d-none"),E()):(document.getElementById("logoutBtn").classList.add("d-none"),v()),document.getElementById("loginBtn").addEventListener("click",p),document.getElementById("logoutBtn").addEventListener("click",I),document.getElementById("passwordToggle").addEventListener("click",S),document.getElementById("loginPassword").addEventListener("keypress",e=>{e.key==="Enter"&&p()})});Object.assign(window,{addRow:b,duplicateRow:w,deleteSelected:x,toggleAll:T,saveDraft:N,loadDraft:O,clearDraft:P,importFile:R,exportJSON:k,exportCSV:D,exportPDF:j,applyTemplate:J,adjustColWidth:C,login:p,logout:I,showLoginPage:v,hideLoginPage:E,togglePassword:S});
