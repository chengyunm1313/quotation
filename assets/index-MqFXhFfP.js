(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&c(r)}).observe(document,{childList:!0,subtree:!0});function e(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function c(o){if(o.ep)return;o.ep=!0;const l=e(o);fetch(o.href,l)}})();document.getElementById("quoteDate").valueAsDate=new Date;document.getElementById("generatedAt").textContent=new Date().toLocaleString();document.getElementById("itemTable").addEventListener("input",function(n){["item-qty","item-price"].some(t=>n.target.classList.contains(t))&&(a(n.target.closest("tr")),d())});window.addRow=function(){const t=document.querySelector("#itemTable tbody"),e=t.querySelector("tr").cloneNode(!0);e.querySelectorAll("input, textarea").forEach(c=>{c.type==="checkbox"?c.checked=!1:c.value=c.classList.contains("item-unit")?"組":""}),e.querySelector(".item-qty").value=1,e.querySelector(".item-price").value=0,e.querySelector(".item-subtotal").textContent="0",t.appendChild(e)};window.deleteSelected=function(){const t=document.querySelector("#itemTable tbody");t.querySelectorAll(".row-chk:checked").forEach(e=>{t.rows.length>1&&e.closest("tr").remove()}),d()};document.getElementById("addBtn")?.addEventListener("click",()=>window.addRow());document.getElementById("duplicateBtn")?.addEventListener("click",()=>window.duplicateRow());document.getElementById("deleteBtn")?.addEventListener("click",()=>window.deleteSelected());document.getElementById("colDecBtn")?.addEventListener("click",()=>window.adjustColWidth(-20));document.getElementById("colIncBtn")?.addEventListener("click",()=>window.adjustColWidth(20));document.getElementById("exportBtn")?.addEventListener("click",()=>window.exportPDF());window.toggleAll=function(t){document.querySelectorAll(".row-chk").forEach(e=>e.checked=t.checked)};function a(n){const t=parseFloat(n.querySelector(".item-qty").value)||0,e=parseFloat(n.querySelector(".item-price").value)||0,c=t*e;n.querySelector(".item-subtotal").textContent=c.toLocaleString()}function d(){const n=parseFloat(document.getElementById("taxRate").value)||0;let t=0;document.querySelectorAll(".item-subtotal").forEach(o=>{t+=parseFloat(o.textContent.replace(/,/g,""))||0});const e=Math.round(t*n/100),c=t+e;document.getElementById("subtotal").textContent=`NT$ ${t.toLocaleString()}`,document.getElementById("tax").textContent=`NT$ ${e.toLocaleString()}`,document.getElementById("total").textContent=`NT$ ${c.toLocaleString()}`}window.saveDraft=function(){const t=[];document.querySelectorAll("#itemTable tbody tr").forEach(e=>{t.push({name:e.querySelector(".item-name").value,desc:e.querySelector(".item-desc").value,unit:e.querySelector(".item-unit").value,qty:+e.querySelector(".item-qty").value||0,price:+e.querySelector(".item-price").value||0})}),localStorage.setItem("quoteDraft",JSON.stringify(t)),alert("已暫存至瀏覽器")};a(document.querySelector("#itemTable tbody tr"));d();$(function(){$("#itemTable").colResizable({liveDrag:!0,minWidth:40})});window.duplicateRow=function(){const t=document.querySelector("#itemTable tbody"),e=[...t.querySelectorAll(".row-chk:checked")];if(!e.length){alert("請先勾選要複製的列");return}e.forEach(c=>{const o=c.closest("tr").cloneNode(!0);o.querySelector(".row-chk").checked=!1,t.appendChild(o),a(o)}),d()};window.loadDraft=function(){const t=localStorage.getItem("quoteDraft");if(!t){alert("沒有暫存資料");return}try{s(JSON.parse(t))}catch{alert("暫存資料格式錯誤")}};window.clearDraft=function(){localStorage.removeItem("quoteDraft"),alert("已清除暫存")};function i(n){document.documentElement.style.setProperty("--col-name-width",`${n}px`),document.querySelectorAll("#itemTable th:nth-child(2), #itemTable td:nth-child(2)").forEach(t=>t.style.width=`${n}px`)}const u=document.getElementById("colWidthSlider");u.addEventListener("input",n=>{i(n.target.value)});i(u.value);window.adjustColWidth=function(t){const e=document.getElementById("colWidthSlider");let c=Math.min(+e.max,Math.max(+e.min,+e.value+t));e.value=c,i(c)};window.exportPDF=function(){const e=document.querySelector(".container-fluid").cloneNode(!0);e.querySelectorAll("textarea").forEach(c=>{const o=document.createElement("div");o.style.cssText="white-space:pre-wrap;border:1px solid #ced4da;padding:.5rem;border-radius:.25rem;font-size:.875rem;",o.textContent=c.value,c.replaceWith(o)}),html2pdf().set({margin:0,filename:"quotation.pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,scrollY:0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all","css","legacy"]}}).from(e).save()};window.importFile=function(t){const e=t.target.files[0];if(!e)return;const c=new FileReader;c.onload=function(o){const l=o.target.result;try{let r=[];e.name.endsWith(".json")?r=JSON.parse(l):l.trim().split(/\r?\n/).slice(1).forEach(m=>{const[y,f,p,h,g]=m.split(",");r.push({name:y,desc:f,unit:p,qty:+h,price:+g})}),s(r)}catch{alert("檔案格式錯誤或內容無法解析")}t.target.value=""},c.readAsText(e,"utf-8")};function s(n){const t=document.querySelector("#itemTable tbody");t.innerHTML="",n.forEach(e=>{const c=document.createElement("tr");c.innerHTML=`
          <td class="text-center"><input type="checkbox" class="row-chk"></td>
          <td><input type="text" class="form-control form-control-sm item-name" value="${e.name||""}"></td>
          <td><textarea class="form-control form-control-sm item-desc" rows="1">${e.desc||""}</textarea></td>
          <td><input type="text" class="form-control form-control-sm item-unit" value="${e.unit||"組"}"></td>
          <td><input type="number" class="form-control form-control-sm item-qty" value="${e.qty||1}" min="1"></td>
          <td><input type="number" class="form-control form-control-sm item-price" value="${e.price||0}"></td>
          <td class="text-end fw-bold item-subtotal">0</td>
        `,t.appendChild(c),a(c)}),d()}document.getElementById("addBtn")?.addEventListener("click",addRow);document.getElementById("duplicateBtn")?.addEventListener("click",duplicateRow);document.getElementById("deleteBtn")?.addEventListener("click",deleteSelected);document.getElementById("colDecBtn")?.addEventListener("click",()=>adjustColWidth(-20));document.getElementById("colIncBtn")?.addEventListener("click",()=>adjustColWidth(20));document.getElementById("exportBtn")?.addEventListener("click",exportPDF);
