(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function l(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(o){if(o.ep)return;o.ep=!0;const n=l(o);fetch(o.href,n)}})();function f(t){typeof t!="string"&&(t=String(t??"")),t=t.replace(/,/g,"").replace(/[^\d.-]/g,"");const e=parseFloat(t);return isNaN(e)?0:e}function h(t){return(+t||0).toLocaleString()}const O="chengyun2025";function w(){const t=document.getElementById("loginPage");t.style.display="flex",document.getElementById("loginPassword").value="",document.getElementById("loginError").classList.remove("show"),setTimeout(()=>{document.getElementById("loginPassword").focus()},100)}function B(){const t=document.getElementById("loginPage");t.style.display="none"}function S(){const t=document.getElementById("loginPassword").value,e=document.getElementById("loginError");t===O?(localStorage.setItem("quotationLoginInfo",JSON.stringify({isLoggedIn:!0,loginTime:new Date().toISOString()})),B(),document.getElementById("logoutBtn").classList.remove("d-none"),e.classList.remove("show")):(e.classList.add("show"),document.getElementById("loginPassword").value="",document.getElementById("loginPassword").focus(),setTimeout(()=>{e.classList.remove("show")},3e3))}function L(){confirm("確定要登出系統嗎？")&&(localStorage.removeItem("quotationLoginInfo"),w(),document.getElementById("logoutBtn").classList.add("d-none"))}function T(){const t=document.getElementById("loginPassword"),l=document.getElementById("passwordToggle").querySelector("i");t.type==="password"?(t.type="text",l.className="bi bi-eye-slash"):(t.type="password",l.className="bi bi-eye")}function C(){const t=document.querySelector("#itemTable tbody"),e=document.createElement("tr");e.innerHTML=`
    <td class="text-center"><input type="checkbox" class="row-chk"></td>
    <td><input type="text" class="form-control form-control-sm item-name"></td>
    <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
    <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
    <td class="text-end fw-bold item-subtotal">0</td>
  `,t.appendChild(e),E(e),g()}function P(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{if(e.querySelector(".row-chk").checked){const l=e.cloneNode(!0);l.querySelector(".row-chk").checked=!1,t.appendChild(l),E(l)}}),g()}function A(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{e.querySelector(".row-chk").checked&&e.remove()}),t.querySelector("tr")||C(),g()}function R(t){const e=t.checked;document.querySelectorAll("#itemTable tbody .row-chk").forEach(l=>l.checked=e)}function E(t){const e=f(t.querySelector(".item-qty")?.value??0),l=f(t.querySelector(".item-price")?.value??0),r=f(t.querySelector(".item-discount")?.value??0),o=Math.max(e*l-r,0);return t.querySelector(".item-subtotal").textContent=h(o),o}function g(){const t=document.querySelectorAll("#itemTable tbody tr");let e=0;t.forEach(n=>e+=E(n));const l=f(document.getElementById("taxRate").value),r=e*(l/100),o=e+r;document.getElementById("subtotal").textContent="NT$ "+h(e),document.getElementById("tax").textContent="NT$ "+h(r),document.getElementById("total").textContent="NT$ "+h(o)}function D(t){const e=document.documentElement;let r=parseInt(getComputedStyle(e).getPropertyValue("--col-name-width")||"180",10)+t;r<100&&(r=100),r>400&&(r=400),e.style.setProperty("--col-name-width",r+"px");const o=document.getElementById("colWidthSlider");o&&(o.value=r)}function k(){return{quoteDate:document.getElementById("quoteDate").value,quoteNo:document.getElementById("quoteNo").value,eventName:document.getElementById("eventName").value,eventDate:document.getElementById("eventDate").value,eventTime:document.getElementById("eventTime").value,venue:document.getElementById("venue").value,account:document.getElementById("account").value,taxRate:document.getElementById("taxRate").value,paymentTerm:document.getElementById("paymentTerm").value,validDays:document.getElementById("validDays").value,clientCompany:document.getElementById("clientCompany").value,clientTax:document.getElementById("clientTax").value,clientContact:document.getElementById("clientContact").value,clientPhone:document.getElementById("clientPhone").value,clientAddress:document.getElementById("clientAddress").value,clientFax:document.getElementById("clientFax").value,clientMobile:document.getElementById("clientMobile").value,clientEmail:document.getElementById("clientEmail").value,vendorCompany:document.getElementById("vendorCompany").value,vendorTax:document.getElementById("vendorTax").value,vendorContact:document.getElementById("vendorContact").value,vendorEmail:document.getElementById("vendorEmail").value,vendorPhone:document.getElementById("vendorPhone").value,vendorAddress:document.getElementById("vendorAddress").value,notes:document.getElementById("notes").value}}function N(t){if(t)for(const e of Object.keys(t)){const l=document.getElementById(e);l&&(l.value=t[e])}}function x(){const t=[];return document.querySelectorAll("#itemTable tbody tr").forEach(e=>{t.push({name:e.querySelector(".item-name").value,desc:e.querySelector(".item-desc").value,unit:e.querySelector(".item-unit").value,qty:e.querySelector(".item-qty").value,price:e.querySelector(".item-price").value,discount:e.querySelector(".item-discount").value})}),t}function v(t){const e=document.querySelector("#itemTable tbody");e.innerHTML="",(t||[]).forEach(l=>{const r=document.createElement("tr");r.innerHTML=`
      <td class="text-center"><input type="checkbox" class="row-chk"></td>
      <td><input type="text" class="form-control form-control-sm item-name" value="${l.name||""}"></td>
      <td><textarea class="form-control form-control-sm item-desc" rows="1">${l.desc||""}</textarea></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${l.unit||"組"}"></td>
      <td><input type="number" class="form-control form-control-sm item-qty" value="${l.qty||1}" min="1" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-price" value="${l.price||0}" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-discount" value="${l.discount||0}" inputmode="decimal"></td>
      <td class="text-end fw-bold item-subtotal">0</td>`,e.appendChild(r),E(r)}),g()}function j(){const t={meta:k(),items:x()};localStorage.setItem("quotationDraft",JSON.stringify(t)),alert("已暫存資料")}function W(){const t=localStorage.getItem("quotationDraft");if(!t){alert("無暫存資料");return}try{const e=JSON.parse(t);N(e.meta),v(e.items),alert("已載入暫存資料")}catch{alert("暫存資料格式不正確")}}function J(){confirm("確認清除暫存？")&&(localStorage.removeItem("quotationDraft"),alert("已清除暫存資料"))}function M(){const t={meta:k(),items:x()},e=JSON.stringify(t,null,2),l=new Blob([e],{type:"application/json"}),r=URL.createObjectURL(l),o=document.createElement("a");o.href=r,o.download=(document.getElementById("quoteNo").value||"quotation")+".json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}function F(){const t=x();if(!t.length){alert("無項目資料可匯出");return}const e=["name","desc","unit","qty","price","discount"],l=[e.join(","),...t.map(s=>e.map(a=>`"${(s[a]||"").toString().replace(/"/g,'""')}"`).join(","))].join(`
`),r=new Blob(["\uFEFF"+l],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(r),n=document.createElement("a");n.href=o,n.download=(document.getElementById("quoteNo").value||"quotation")+"_items.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o)}function $(t){const e=t.target.files[0];if(!e)return;const l=new FileReader;l.onload=r=>{const o=r.target.result;if(e.name.endsWith(".json"))try{const n=JSON.parse(o);Array.isArray(n)?n.length?(v(n),alert("已匯入 JSON")):alert("JSON 內容無有效項目"):n&&Array.isArray(n.items)&&n.items.length?(N(n.meta||{}),v(n.items),alert("已匯入 JSON")):alert("JSON 內容無有效項目")}catch{alert("JSON 格式錯誤")}else e.name.endsWith(".csv")?H(o):alert("不支援的檔案類型")},l.readAsText(e),t.target.value=""}function H(t){const e=t.trim().split(/\r?\n/);if(e.length<2){alert("CSV 無資料");return}function l(n){const s=[];let a="",y=!1;for(let d=0;d<n.length;d++){const u=n[d],q=n[d+1];u==='"'?y&&q==='"'?(a+='"',d++):y=!y:u===","&&!y?(s.push(a.trim()),a=""):a+=u}return s.push(a.trim()),s}const r=l(e[0]).map(n=>n.trim()),o=[];for(let n=1;n<e.length;n++){if(!e[n].trim())continue;const s=l(e[n]),a={};r.forEach((y,d)=>{let u=s[d]?s[d].trim():"";u.startsWith('"')&&u.endsWith('"')&&(u=u.slice(1,-1)),a[y]=u}),o.push({name:a.name||"",desc:a.desc||"",unit:a.unit||"組",qty:a.qty||1,price:a.price||0,discount:a.discount||0})}o.length?(v(o),alert("已匯入 CSV")):alert("CSV 內容無有效項目，保留原表格")}function U(){document.getElementById("generatedAt").textContent=new Date().toLocaleString();const t=document.getElementById("notes"),e=document.getElementById("notesDisplay"),l=t.value.split(`
`).filter(o=>o.trim()!=="").map(o=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${o}</p>`).join("");e.innerHTML=l,e.style.position="static",e.style.display="block",e.style.width="100%",e.style.border="1px solid #dee2e6",e.style.borderRadius="0.375rem",e.style.padding="0.5rem",e.style.fontSize="0.875rem",e.style.backgroundColor="white",e.classList.remove("d-none"),t.classList.add("d-none");const r=document.querySelector(".container-fluid");r.classList.add("pdf-export"),setTimeout(()=>{const o=document.querySelector(".container-fluid"),n={margin:0,filename:(document.getElementById("quoteNo").value||"quotation")+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,scrollY:0,windowWidth:document.documentElement.offsetWidth,windowHeight:document.documentElement.offsetHeight,logging:!1,onclone:function(s){s.querySelector(".container-fluid").classList.add("pdf-export"),s.querySelectorAll(".no-print, .d-flex.flex-wrap.align-items-center.gap-2.mt-4.mb-2").forEach(i=>{i.style.display="none",i.style.height="0",i.style.margin="0",i.style.padding="0",i.style.overflow="hidden"});const d=s.querySelector("#itemTable");d&&(d.style.tableLayout="fixed",d.style.width="100%"),s.querySelectorAll("#itemTable th:nth-child(3), #itemTable td:nth-child(3)").forEach(i=>{i.style.wordWrap="break-word",i.style.overflowWrap="break-word",i.style.wordBreak="break-word",i.style.whiteSpace="normal",i.style.overflow="visible",i.style.width="250px",i.style.minWidth="200px",i.style.maxWidth="300px",i.style.verticalAlign="top"}),s.querySelectorAll(".item-desc").forEach(i=>{const p=i.value||"",c=s.createElement("div");c.textContent=p,c.style.whiteSpace="pre-wrap",c.style.wordWrap="break-word",c.style.overflowWrap="break-word",c.style.wordBreak="break-word",c.style.height="auto",c.style.minHeight="auto",c.style.overflow="visible",c.style.maxWidth="100%",c.style.width="100%",c.style.boxSizing="border-box",c.style.border="1px solid #dee2e6",c.style.padding="0.375rem 0.75rem",c.style.fontSize="0.875rem",c.style.lineHeight="1.4",c.style.backgroundColor="white",c.style.fontFamily='"Microsoft JhengHei", sans-serif',i.parentNode.replaceChild(c,i)});const b=s.getElementById("notes"),m=s.getElementById("notesDisplay");if(b&&m){const i=b.value.split(`
`).filter(p=>p.trim()!=="").map(p=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${p}</p>`).join("");m.innerHTML=i,m.style.position="static",m.style.display="block",m.style.width="100%",m.style.border="1px solid #dee2e6",m.style.borderRadius="0.375rem",m.style.padding="0.5rem",m.style.fontSize="0.875rem",m.style.backgroundColor="white",m.classList.remove("d-none"),b.classList.add("d-none")}}},jsPDF:{unit:"in",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all"]}};html2pdf().set(n).from(o).save().then(()=>{setTimeout(()=>{r.classList.remove("pdf-export"),e.classList.add("d-none"),t.classList.remove("d-none"),e.style.position="",e.style.display="",e.style.width="",e.style.border="",e.style.borderRadius="",e.style.padding="",e.style.fontSize="",e.style.backgroundColor=""},1e3)})},100)}const I="quoteTemplates";localStorage.getItem(I)||localStorage.setItem(I,JSON.stringify([{name:"網站建置",desc:"五頁靜態官網",unit:"案",qty:1,price:3e4,discount:0},{name:"維護費",desc:"一年維護服務",unit:"年",qty:1,price:12e3,discount:0}]));function V(){const t=JSON.parse(localStorage.getItem(I)||"[]");if(!t.length){alert("尚未建立模板");return}v(t)}document.getElementById("itemTable").addEventListener("input",t=>{["item-qty","item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(E(t.target.closest("tr")),g())});document.getElementById("itemTable").addEventListener("blur",t=>{["item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(t.target.value=h(f(t.target.value)))},!0);document.getElementById("colWidthSlider").addEventListener("input",t=>{document.documentElement.style.setProperty("--col-name-width",t.target.value+"px")});document.getElementById("taxRate").addEventListener("input",g);document.addEventListener("DOMContentLoaded",()=>{document.documentElement.style.setProperty("--col-name-width","180px"),document.getElementById("generatedAt").textContent=new Date().toLocaleString(),g();const t=JSON.parse(localStorage.getItem("quotationLoginInfo")||"null");t&&t.isLoggedIn?(document.getElementById("logoutBtn").classList.remove("d-none"),B()):(document.getElementById("logoutBtn").classList.add("d-none"),w()),document.getElementById("loginBtn").addEventListener("click",S),document.getElementById("logoutBtn").addEventListener("click",L),document.getElementById("passwordToggle").addEventListener("click",T),document.getElementById("loginPassword").addEventListener("keypress",e=>{e.key==="Enter"&&S()})});Object.assign(window,{addRow:C,duplicateRow:P,deleteSelected:A,toggleAll:R,saveDraft:j,loadDraft:W,clearDraft:J,importFile:$,exportJSON:M,exportCSV:F,exportPDF:U,applyTemplate:V,adjustColWidth:D,login:S,logout:L,showLoginPage:w,hideLoginPage:B,togglePassword:T});
