(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&c(r)}).observe(document,{childList:!0,subtree:!0});function l(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(o){if(o.ep)return;o.ep=!0;const n=l(o);fetch(o.href,n)}})();function g(t){typeof t!="string"&&(t=String(t??"")),t=t.replace(/,/g,"").replace(/[^\d.-]/g,"");const e=parseFloat(t);return isNaN(e)?0:e}function p(t){return(+t||0).toLocaleString()}const C="chengyun2025";function S(){const t=document.getElementById("loginPage");t.style.display="flex",document.getElementById("loginPassword").value="",document.getElementById("loginError").classList.remove("show"),setTimeout(()=>{document.getElementById("loginPassword").focus()},100)}function b(){const t=document.getElementById("loginPage");t.style.display="none"}function E(){const t=document.getElementById("loginPassword").value,e=document.getElementById("loginError");t===C?(localStorage.setItem("quotationLoginInfo",JSON.stringify({isLoggedIn:!0,loginTime:new Date().toISOString()})),b(),document.getElementById("logoutBtn").classList.remove("d-none"),e.classList.remove("show")):(e.classList.add("show"),document.getElementById("loginPassword").value="",document.getElementById("loginPassword").focus(),setTimeout(()=>{e.classList.remove("show")},3e3))}function w(){confirm("確定要登出系統嗎？")&&(localStorage.removeItem("quotationLoginInfo"),S(),document.getElementById("logoutBtn").classList.add("d-none"))}function q(){const t=document.getElementById("loginPassword"),l=document.getElementById("passwordToggle").querySelector("i");t.type==="password"?(t.type="text",l.className="bi bi-eye-slash"):(t.type="password",l.className="bi bi-eye")}function L(){const t=document.querySelector("#itemTable tbody"),e=document.createElement("tr");e.innerHTML=`
    <td class="text-center"><input type="checkbox" class="row-chk"></td>
    <td><input type="text" class="form-control form-control-sm item-name"></td>
    <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
    <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
    <td class="text-end fw-bold item-subtotal">0</td>
  `,t.appendChild(e),v(e),y()}function N(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{if(e.querySelector(".row-chk").checked){const l=e.cloneNode(!0);l.querySelector(".row-chk").checked=!1,t.appendChild(l),v(l)}}),y()}function O(){const t=document.querySelector("#itemTable tbody");[...t.querySelectorAll("tr")].forEach(e=>{e.querySelector(".row-chk").checked&&e.remove()}),t.querySelector("tr")||L(),y()}function P(t){const e=t.checked;document.querySelectorAll("#itemTable tbody .row-chk").forEach(l=>l.checked=e)}function v(t){const e=g(t.querySelector(".item-qty")?.value??0),l=g(t.querySelector(".item-price")?.value??0),c=g(t.querySelector(".item-discount")?.value??0),o=Math.max(e*l-c,0);return t.querySelector(".item-subtotal").textContent=p(o),o}function y(){const t=document.querySelectorAll("#itemTable tbody tr");let e=0;t.forEach(n=>e+=v(n));const l=g(document.getElementById("taxRate").value),c=e*(l/100),o=e+c;document.getElementById("subtotal").textContent="NT$ "+p(e),document.getElementById("tax").textContent="NT$ "+p(c),document.getElementById("total").textContent="NT$ "+p(o)}function k(t){const e=document.documentElement;let c=parseInt(getComputedStyle(e).getPropertyValue("--col-name-width")||"180",10)+t;c<100&&(c=100),c>400&&(c=400),e.style.setProperty("--col-name-width",c+"px");const o=document.getElementById("colWidthSlider");o&&(o.value=c)}function x(){return{quoteDate:document.getElementById("quoteDate").value,quoteNo:document.getElementById("quoteNo").value,eventName:document.getElementById("eventName").value,eventDate:document.getElementById("eventDate").value,eventTime:document.getElementById("eventTime").value,venue:document.getElementById("venue").value,account:document.getElementById("account").value,taxRate:document.getElementById("taxRate").value,paymentTerm:document.getElementById("paymentTerm").value,validDays:document.getElementById("validDays").value,clientCompany:document.getElementById("clientCompany").value,clientTax:document.getElementById("clientTax").value,clientContact:document.getElementById("clientContact").value,clientPhone:document.getElementById("clientPhone").value,clientAddress:document.getElementById("clientAddress").value,clientFax:document.getElementById("clientFax").value,clientMobile:document.getElementById("clientMobile").value,clientEmail:document.getElementById("clientEmail").value,vendorCompany:document.getElementById("vendorCompany").value,vendorTax:document.getElementById("vendorTax").value,vendorContact:document.getElementById("vendorContact").value,vendorEmail:document.getElementById("vendorEmail").value,vendorPhone:document.getElementById("vendorPhone").value,vendorAddress:document.getElementById("vendorAddress").value,notes:document.getElementById("notes").value}}function T(t){if(t)for(const e of Object.keys(t)){const l=document.getElementById(e);l&&(l.value=t[e])}}function B(){const t=[];return document.querySelectorAll("#itemTable tbody tr").forEach(e=>{t.push({name:e.querySelector(".item-name").value,desc:e.querySelector(".item-desc").value,unit:e.querySelector(".item-unit").value,qty:e.querySelector(".item-qty").value,price:e.querySelector(".item-price").value,discount:e.querySelector(".item-discount").value})}),t}function f(t){const e=document.querySelector("#itemTable tbody");e.innerHTML="",(t||[]).forEach(l=>{const c=document.createElement("tr");c.innerHTML=`
      <td class="text-center"><input type="checkbox" class="row-chk"></td>
      <td><input type="text" class="form-control form-control-sm item-name" value="${l.name||""}"></td>
      <td><textarea class="form-control form-control-sm item-desc" rows="1">${l.desc||""}</textarea></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${l.unit||"組"}"></td>
      <td><input type="number" class="form-control form-control-sm item-qty" value="${l.qty||1}" min="1" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-price" value="${l.price||0}" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-discount" value="${l.discount||0}" inputmode="decimal"></td>
      <td class="text-end fw-bold item-subtotal">0</td>`,e.appendChild(c),v(c)}),y()}function A(){const t={meta:x(),items:B()};localStorage.setItem("quotationDraft",JSON.stringify(t)),alert("已暫存資料")}function R(){const t=localStorage.getItem("quotationDraft");if(!t){alert("無暫存資料");return}try{const e=JSON.parse(t);T(e.meta),f(e.items),alert("已載入暫存資料")}catch{alert("暫存資料格式不正確")}}function D(){confirm("確認清除暫存？")&&(localStorage.removeItem("quotationDraft"),alert("已清除暫存資料"))}function j(){const t={meta:x(),items:B()},e=JSON.stringify(t,null,2),l=new Blob([e],{type:"application/json"}),c=URL.createObjectURL(l),o=document.createElement("a");o.href=c,o.download=(document.getElementById("quoteNo").value||"quotation")+".json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(c)}function J(){const t=B();if(!t.length){alert("無項目資料可匯出");return}const e=["name","desc","unit","qty","price","discount"],l=[e.join(","),...t.map(r=>e.map(s=>`"${(r[s]||"").toString().replace(/"/g,'""')}"`).join(","))].join(`
`),c=new Blob(["\uFEFF"+l],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(c),n=document.createElement("a");n.href=o,n.download=(document.getElementById("quoteNo").value||"quotation")+"_items.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o)}function M(t){const e=t.target.files[0];if(!e)return;const l=new FileReader;l.onload=c=>{const o=c.target.result;if(e.name.endsWith(".json"))try{const n=JSON.parse(o);Array.isArray(n)?n.length?(f(n),alert("已匯入 JSON")):alert("JSON 內容無有效項目"):n&&Array.isArray(n.items)&&n.items.length?(T(n.meta||{}),f(n.items),alert("已匯入 JSON")):alert("JSON 內容無有效項目")}catch{alert("JSON 格式錯誤")}else e.name.endsWith(".csv")?F(o):alert("不支援的檔案類型")},l.readAsText(e),t.target.value=""}function F(t){const e=t.trim().split(/\r?\n/);if(e.length<2){alert("CSV 無資料");return}function l(n){const r=[];let s="",u=!1;for(let m=0;m<n.length;m++){const a=n[m],d=n[m+1];a==='"'?u&&d==='"'?(s+='"',m++):u=!u:a===","&&!u?(r.push(s.trim()),s=""):s+=a}return r.push(s.trim()),r}const c=l(e[0]).map(n=>n.trim()),o=[];for(let n=1;n<e.length;n++){if(!e[n].trim())continue;const r=l(e[n]),s={};c.forEach((u,m)=>{let a=r[m]?r[m].trim():"";a.startsWith('"')&&a.endsWith('"')&&(a=a.slice(1,-1)),s[u]=a}),o.push({name:s.name||"",desc:s.desc||"",unit:s.unit||"組",qty:s.qty||1,price:s.price||0,discount:s.discount||0})}o.length?(f(o),alert("已匯入 CSV")):alert("CSV 內容無有效項目，保留原表格")}function W(){document.getElementById("generatedAt").textContent=new Date().toLocaleString();const t=document.getElementById("notes"),e=document.getElementById("notesDisplay"),l=t.value.split(`
`).filter(o=>o.trim()!=="").map(o=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${o}</p>`).join("");e.innerHTML=l,e.style.position="static",e.style.display="block",e.style.width="100%",e.style.border="1px solid #dee2e6",e.style.borderRadius="0.375rem",e.style.padding="0.5rem",e.style.fontSize="0.875rem",e.style.backgroundColor="white",e.classList.remove("d-none"),t.classList.add("d-none");const c=document.querySelector(".container-fluid");c.classList.add("pdf-export"),setTimeout(()=>{const o=document.querySelector(".container-fluid"),n={margin:0,filename:(document.getElementById("quoteNo").value||"quotation")+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,scrollY:0,windowWidth:document.documentElement.offsetWidth,windowHeight:document.documentElement.offsetHeight,logging:!1,onclone:function(r){r.querySelector(".container-fluid").classList.add("pdf-export"),r.querySelectorAll(".no-print, .d-flex.flex-wrap.align-items-center.gap-2.mt-4.mb-2").forEach(i=>{i.style.display="none",i.style.height="0",i.style.margin="0",i.style.padding="0",i.style.overflow="hidden"}),r.querySelectorAll(".item-desc").forEach(i=>{i.style.whiteSpace="pre-wrap",i.style.wordWrap="break-word",i.style.overflowWrap="break-word",i.style.height="auto",i.style.minHeight="auto",i.style.overflow="visible"});const a=r.getElementById("notes"),d=r.getElementById("notesDisplay");if(a&&d){const i=a.value.split(`
`).filter(h=>h.trim()!=="").map(h=>`<p style="margin-bottom:0.5rem;line-height:1.5;">${h}</p>`).join("");d.innerHTML=i,d.style.position="static",d.style.display="block",d.style.width="100%",d.style.border="1px solid #dee2e6",d.style.borderRadius="0.375rem",d.style.padding="0.5rem",d.style.fontSize="0.875rem",d.style.backgroundColor="white",d.classList.remove("d-none"),a.classList.add("d-none")}}},jsPDF:{unit:"in",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all"]}};html2pdf().set(n).from(o).save().then(()=>{setTimeout(()=>{c.classList.remove("pdf-export"),e.classList.add("d-none"),t.classList.remove("d-none"),e.style.position="",e.style.display="",e.style.width="",e.style.border="",e.style.borderRadius="",e.style.padding="",e.style.fontSize="",e.style.backgroundColor=""},1e3)})},100)}const I="quoteTemplates";localStorage.getItem(I)||localStorage.setItem(I,JSON.stringify([{name:"網站建置",desc:"五頁靜態官網",unit:"案",qty:1,price:3e4,discount:0},{name:"維護費",desc:"一年維護服務",unit:"年",qty:1,price:12e3,discount:0}]));function $(){const t=JSON.parse(localStorage.getItem(I)||"[]");if(!t.length){alert("尚未建立模板");return}f(t)}document.getElementById("itemTable").addEventListener("input",t=>{["item-qty","item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(v(t.target.closest("tr")),y())});document.getElementById("itemTable").addEventListener("blur",t=>{["item-price","item-discount"].some(e=>t.target.classList.contains(e))&&(t.target.value=p(g(t.target.value)))},!0);document.getElementById("colWidthSlider").addEventListener("input",t=>{document.documentElement.style.setProperty("--col-name-width",t.target.value+"px")});document.getElementById("taxRate").addEventListener("input",y);document.addEventListener("DOMContentLoaded",()=>{document.documentElement.style.setProperty("--col-name-width","180px"),document.getElementById("generatedAt").textContent=new Date().toLocaleString(),y();const t=JSON.parse(localStorage.getItem("quotationLoginInfo")||"null");t&&t.isLoggedIn?(document.getElementById("logoutBtn").classList.remove("d-none"),b()):(document.getElementById("logoutBtn").classList.add("d-none"),S()),document.getElementById("loginBtn").addEventListener("click",E),document.getElementById("logoutBtn").addEventListener("click",w),document.getElementById("passwordToggle").addEventListener("click",q),document.getElementById("loginPassword").addEventListener("keypress",e=>{e.key==="Enter"&&E()})});Object.assign(window,{addRow:L,duplicateRow:N,deleteSelected:O,toggleAll:P,saveDraft:A,loadDraft:R,clearDraft:D,importFile:M,exportJSON:j,exportCSV:J,exportPDF:W,applyTemplate:$,adjustColWidth:k,login:E,logout:w,showLoginPage:S,hideLoginPage:b,togglePassword:q});
