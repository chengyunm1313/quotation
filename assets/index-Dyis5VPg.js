(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))c(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&c(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function c(n){if(n.ep)return;n.ep=!0;const l=o(n);fetch(n.href,l)}})();function i(e){typeof e!="string"&&(e=String(e??"")),e=e.replace(/,/g,"").replace(/[^\d.-]/g,"");const t=parseFloat(e);return isNaN(t)?0:t}function d(e){return(+e||0).toLocaleString()}function f(){const e=document.querySelector("#itemTable tbody"),t=document.createElement("tr");t.innerHTML=`
    <td class="text-center"><input type="checkbox" class="row-chk"></td>
    <td><input type="text" class="form-control form-control-sm item-name"></td>
    <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
    <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
    <td class="text-end fw-bold item-subtotal">0</td>
  `,e.appendChild(t),m(t),a()}function v(){const e=document.querySelector("#itemTable tbody");[...e.querySelectorAll("tr")].forEach(t=>{if(t.querySelector(".row-chk").checked){const o=t.cloneNode(!0);o.querySelector(".row-chk").checked=!1,e.appendChild(o),m(o)}}),a()}function E(){const e=document.querySelector("#itemTable tbody");[...e.querySelectorAll("tr")].forEach(t=>{t.querySelector(".row-chk").checked&&t.remove()}),e.querySelector("tr")||f(),a()}function h(e){const t=e.checked;document.querySelectorAll("#itemTable tbody .row-chk").forEach(o=>o.checked=t)}function m(e){const t=i(e.querySelector(".item-qty")?.value??0),o=i(e.querySelector(".item-price")?.value??0),c=i(e.querySelector(".item-discount")?.value??0),n=Math.max(t*o-c,0);return e.querySelector(".item-subtotal").textContent=d(n),n}function a(){const e=document.querySelectorAll("#itemTable tbody tr");let t=0;e.forEach(l=>t+=m(l));const o=i(document.getElementById("taxRate").value),c=t*(o/100),n=t+c;document.getElementById("subtotal").textContent="NT$ "+d(t),document.getElementById("tax").textContent="NT$ "+d(c),document.getElementById("total").textContent="NT$ "+d(n)}function S(e){const t=document.documentElement;let c=parseInt(getComputedStyle(t).getPropertyValue("--col-name-width")||"180",10)+e;c<100&&(c=100),c>400&&(c=400),t.style.setProperty("--col-name-width",c+"px");const n=document.getElementById("colWidthSlider");n&&(n.value=c)}function q(){return{quoteDate:document.getElementById("quoteDate").value,quoteNo:document.getElementById("quoteNo").value,eventName:document.getElementById("eventName").value,eventDate:document.getElementById("eventDate").value,eventTime:document.getElementById("eventTime").value,venue:document.getElementById("venue").value,account:document.getElementById("account").value,taxRate:document.getElementById("taxRate").value,paymentTerm:document.getElementById("paymentTerm").value,validDays:document.getElementById("validDays").value,clientCompany:document.getElementById("clientCompany").value,clientContact:document.getElementById("clientContact").value,clientPhone:document.getElementById("clientPhone").value,clientAddress:document.getElementById("clientAddress").value,clientFax:document.getElementById("clientFax").value,clientMobile:document.getElementById("clientMobile").value,clientEmail:document.getElementById("clientEmail").value,vendorCompany:document.getElementById("vendorCompany").value,vendorTax:document.getElementById("vendorTax").value,vendorContact:document.getElementById("vendorContact").value,vendorEmail:document.getElementById("vendorEmail").value,vendorPhone:document.getElementById("vendorPhone").value,vendorAddress:document.getElementById("vendorAddress").value,notes:document.getElementById("notes").value}}function p(e){if(e)for(const t of Object.keys(e)){const o=document.getElementById(t);o&&(o.value=e[t])}}function I(){const e=[];return document.querySelectorAll("#itemTable tbody tr").forEach(t=>{e.push({name:t.querySelector(".item-name").value,desc:t.querySelector(".item-desc").value,unit:t.querySelector(".item-unit").value,qty:t.querySelector(".item-qty").value,price:t.querySelector(".item-price").value,discount:t.querySelector(".item-discount").value})}),e}function u(e){const t=document.querySelector("#itemTable tbody");t.innerHTML="",(e||[]).forEach(o=>{const c=document.createElement("tr");c.innerHTML=`
      <td class="text-center"><input type="checkbox" class="row-chk"></td>
      <td><input type="text" class="form-control form-control-sm item-name" value="${o.name||""}"></td>
      <td><textarea class="form-control form-control-sm item-desc" rows="1">${o.desc||""}</textarea></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${o.unit||"組"}"></td>
      <td><input type="number" class="form-control form-control-sm item-qty" value="${o.qty||1}" min="1" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-price" value="${o.price||0}" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-discount" value="${o.discount||0}" inputmode="decimal"></td>
      <td class="text-end fw-bold item-subtotal">0</td>`,t.appendChild(c),m(c)}),a()}function b(){const e={meta:q(),items:I()};localStorage.setItem("quotationDraft",JSON.stringify(e)),alert("已暫存資料")}function x(){const e=localStorage.getItem("quotationDraft");if(!e){alert("無暫存資料");return}try{const t=JSON.parse(e);p(t.meta),u(t.items),alert("已載入暫存資料")}catch{alert("暫存資料格式不正確")}}function B(){confirm("確認清除暫存？")&&(localStorage.removeItem("quotationDraft"),alert("已清除暫存資料"))}function T(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=c=>{const n=c.target.result;if(t.name.endsWith(".json"))try{const l=JSON.parse(n);l&&Array.isArray(l.items)&&l.items.length?(p(l.meta||{}),u(l.items),alert("已匯入 JSON")):alert("JSON 內容無有效項目")}catch{alert("JSON 格式錯誤")}else t.name.endsWith(".csv")?C(n):alert("不支援的檔案類型")},o.readAsText(t),e.target.value=""}function C(e){const t=e.trim().split(/\r?\n/);if(t.length<2){alert("CSV 無資料");return}const o=t[0].split(","),c=[];for(let n=1;n<t.length;n++){const l=t[n].split(","),r={};o.forEach((g,y)=>r[g.trim()]=l[y]?l[y].trim():""),c.push({name:r.name||"",desc:r.desc||"",unit:r.unit||"",qty:r.qty||1,price:r.price||0,discount:r.discount||0})}c.length?(u(c),alert("已匯入 CSV")):alert("CSV 內容無有效項目，保留原表格")}function N(){document.getElementById("generatedAt").textContent=new Date().toLocaleString();const e=document.querySelector(".container-fluid"),t={margin:0,filename:(document.getElementById("quoteNo").value||"quotation")+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,scrollY:0},jsPDF:{unit:"in",format:"a4",orientation:"portrait"},pagebreak:{mode:["avoid-all"]}};html2pdf().set(t).from(e).save()}const s="quoteTemplates";localStorage.getItem(s)||localStorage.setItem(s,JSON.stringify([{name:"網站建置",desc:"五頁靜態官網",unit:"案",qty:1,price:3e4,discount:0},{name:"維護費",desc:"一年維護服務",unit:"年",qty:1,price:12e3,discount:0}]));function w(){const e=JSON.parse(localStorage.getItem(s)||"[]");if(!e.length){alert("尚未建立模板");return}u(e)}document.getElementById("itemTable").addEventListener("input",e=>{["item-qty","item-price","item-discount"].some(t=>e.target.classList.contains(t))&&(m(e.target.closest("tr")),a())});document.getElementById("itemTable").addEventListener("blur",e=>{["item-price","item-discount"].some(t=>e.target.classList.contains(t))&&(e.target.value=d(i(e.target.value)))},!0);document.getElementById("colWidthSlider").addEventListener("input",e=>{document.documentElement.style.setProperty("--col-name-width",e.target.value+"px")});document.getElementById("taxRate").addEventListener("input",a);document.addEventListener("DOMContentLoaded",()=>{document.documentElement.style.setProperty("--col-name-width","180px"),document.getElementById("generatedAt").textContent=new Date().toLocaleString(),a()});Object.assign(window,{addRow:f,duplicateRow:v,deleteSelected:E,toggleAll:h,saveDraft:b,loadDraft:x,clearDraft:B,importFile:T,exportPDF:N,applyTemplate:w,adjustColWidth:S});
