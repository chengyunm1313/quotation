<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>服務估價單 | 程云行銷顧問有限公司</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- jQuery (for colResizable & any $ helpers) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" crossorigin href="/quotation/assets/index-By_ZDuU6.css">
</head>
<body>
  <!-- ================= HEADER ================= -->
  <div class="container-fluid bg-white p-4 shadow-sm rounded">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="mb-0">服務估價單</h1>
        <small class="text-muted">程云行銷顧問有限公司</small>
      </div>
      <button class="btn btn-primary btn-sm no-print" onclick="window.print()">
        <i class="bi bi-printer"></i> 列印 / 下載 PDF
      </button>
    </div>

    <!-- ===== Meta Info ===== -->
    <div class="row g-2 small meta-info boxed">
      <div>
        <label class="form-label mb-1">估價日期</label>
        <input type="date" id="quoteDate" class="form-control">
      </div>
      <div>
        <label class="form-label mb-1">估價單號</label>
        <input type="text" id="quoteNo" class="form-control" placeholder="Q3-123456001">
      </div>
      <div>
        <label class="form-label mb-1">活動名稱</label>
        <input type="text" id="eventName" class="form-control" placeholder="AI顧問應用 - 企業內訓">
      </div>
      <div>
        <label class="form-label mb-1">活動日期</label>
        <input type="date" id="eventDate" class="form-control">
      </div>
      <div>
        <label class="form-label mb-1">時間</label>
        <input type="text" id="eventTime" class="form-control" placeholder="13:00~15:00">
      </div>
      <div>
        <label class="form-label mb-1">地點</label>
        <input type="text" id="venue" class="form-control" placeholder="貴公司會議室">
      </div>
      <div>
        <label class="form-label mb-1">帳別</label>
        <input type="text" id="account" class="form-control" value="NT$">
      </div>
      <div>
        <label class="form-label mb-1">稅率%</label>
        <input type="number" id="taxRate" class="form-control" value="5">
      </div>
      <div>
        <label class="form-label mb-1">付款</label>
        <input type="text" id="paymentTerm" class="form-control" placeholder="馬上結帳">
      </div>
      <div>
        <label class="form-label mb-1">有效期</label>
        <input type="text" id="validDays" class="form-control" value="發出日起14日">
      </div>
    </div>

    <!-- ===== 客戶資料 & 簽章 ===== -->
    <div class="row gx-2 gy-3 mt-4 small align-items-stretch">
      <div class="col-md-6 boxed">
        <h6>客戶資料</h6>
        <div class="row g-2">
          <div class="col-12">
            <input type="text" class="form-control" id="clientCompany" placeholder="客戶公司名稱">
          </div>
          <div class="col-6">
            <input type="text" class="form-control" id="clientContact" placeholder="聯絡人">
          </div>
          <div class="col-6">
            <input type="text" class="form-control" id="clientPhone" placeholder="電話">
          </div>
          <div class="col-12">
            <input type="text" class="form-control" id="clientAddress" placeholder="地址">
          </div>
          <div class="col-6">
            <input type="text" class="form-control" id="clientFax" placeholder="傳真">
          </div>
          <div class="col-6">
            <input type="text" class="form-control" id="clientMobile" placeholder="手機">
          </div>
          <div class="col-12">
            <input type="email" class="form-control" id="clientEmail" placeholder="Email">
          </div>
        </div>
      </div>
      <div class="col-md-6 boxed d-flex flex-column">
        <h6>客戶簽章</h6>
        <div class="signature-box">簽章 / Signature：</div>
      </div>
    </div>

    <!-- ===== 我方公司固定資訊 ===== -->
    <div class="row mt-3 small">
      <div class="col-12">
        <fieldset class="vendor-box boxed position-relative p-2">
          <legend class="float-none w-auto px-2 small mb-0">供應商資料</legend>
          <button type="button"
                  class="btn btn-outline-primary btn-sm position-absolute top-0 end-0 translate-middle-y no-print"
                  style="font-size:.75rem"
                  onclick="this.closest('fieldset').classList.toggle('collapsed')">
            展開供應商
          </button>
          <div class="row g-2 mb-2">
            <div class="col-md-4">
              <label class="form-label mb-0 small">公司</label>
              <input type="text" class="form-control form-control-sm" id="vendorCompany"
                     value="程云行銷顧問有限公司">
            </div>
            <div class="col-md-2">
              <label class="form-label mb-0 small">統編</label>
              <input type="text" class="form-control form-control-sm" id="vendorTax"
                     value="90659194">
            </div>
            <div class="col-md-3">
              <label class="form-label mb-0 small">聯絡人</label>
              <input type="text" class="form-control form-control-sm" id="vendorContact"
                     value="徐享">
            </div>
          </div>
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label mb-0 small">Email</label>
              <input type="email" class="form-control form-control-sm" id="vendorEmail"
                     value="chengyunm1313@gmail.com">
            </div>
            <div class="col-md-3">
              <label class="form-label mb-0 small">電話</label>
              <input type="text" class="form-control form-control-sm" id="vendorPhone"
                     value="0901-454914">
            </div>
            <div class="col-md-6">
              <label class="form-label mb-0 small">地址</label>
              <input type="text" class="form-control form-control-sm" id="vendorAddress"
                     value="新北市中和區景平路 746 號 5 樓">
            </div>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- ===== 操作按鈕列 ===== -->
    <div class="d-flex flex-wrap align-items-center gap-2 mt-4 mb-2 no-print">

      <!-- 項目操作 -->
      <div class="btn-group me-2" role="group">
        <button class="btn btn-primary btn-sm" title="新增一列" onclick="addRow()">
          <i class="bi bi-plus-circle"></i> 新增
        </button>
        <button class="btn btn-secondary btn-sm" title="複製勾選列" onclick="duplicateRow()">
          <i class="bi bi-files"></i> 複製
        </button>
        <button class="btn btn-danger btn-sm" title="刪除勾選列" onclick="deleteSelected()">
          <i class="bi bi-trash"></i> 刪除
        </button>
      </div>

      <!-- 資料處理 -->
      <div class="btn-group me-2" role="group">
        <button class="btn btn-outline-primary btn-sm" title="縮小欄寬" onclick="adjustColWidth(-20)">
          <i class="bi bi-chevron-left"></i> 精簡
        </button>
        <button class="btn btn-outline-primary btn-sm" title="放寬欄寬" onclick="adjustColWidth(20)">
          <i class="bi bi-chevron-right"></i> 再寬
        </button>
        <button class="btn btn-outline-warning btn-sm" title="重新計算金額" onclick="calculateTotal()">
          <i class="bi bi-calculator"></i> 重算
        </button>
      </div>

      <!-- 欄寬滑桿 -->
      <label class="ms-1 small mb-0">欄寬</label>
      <input type="range" id="colWidthSlider" class="form-range" style="width:150px"
             min="100" max="400" value="180">

      <!-- 存取 -->
      <div class="btn-group me-2" role="group">
        <button class="btn btn-success btn-sm" title="暫存至瀏覽器" onclick="saveDraft()">
          <i class="bi bi-save"></i> 暫存
        </button>
        <button class="btn btn-outline-secondary btn-sm" title="載入暫存" onclick="loadDraft()">
          <i class="bi bi-folder2-open"></i> 載入
        </button>
        <label class="btn btn-outline-secondary btn-sm mb-0" title="匯入 JSON / CSV">
          <i class="bi bi-upload"></i> 匯入
          <input type="file" id="fileInput" hidden accept=".json,.csv" onchange="importFile(event)">
        </label>
      </div>

      <!-- 範例檔下載 -->
      <div class="d-flex flex-wrap align-items-center gap-2">
        <a href="./demo.json" download class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-file-earmark-code"></i> 下載 JSON 範例
        </a>
        <a href="./demo.csv" download class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-file-earmark-spreadsheet"></i> 下載 CSV 範例
        </a>
      </div>

      <!-- PDF / 清除 -->
      <div class="btn-group me-2" role="group">
        <button class="btn btn-primary btn-sm" title="匯出 PDF" onclick="exportPDF()">
          <i class="bi bi-printer"></i> PDF
        </button>
        <button class="btn btn-danger btn-sm" title="清除暫存" onclick="clearDraft()">
          <i class="bi bi-x-circle"></i> 清暫存
        </button>
      </div>

      <!-- 套用模板 -->
      <div class="btn-group me-2" role="group">
        <button class="btn btn-outline-secondary btn-sm" title="套用範例項目" onclick="applyTemplate()">
          <i class="bi bi-stars"></i> 套用模板
        </button>
      </div>

    </div>

    <!-- ===== 服務項目表格 ===== -->
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle" id="itemTable">
        <thead class="table-light text-center">
          <tr>
            <th style="width:30px"><input type="checkbox" id="chkAll" onclick="toggleAll(this)"></th>
            <th>服務項目</th>
            <th>內容說明</th>
            <th style="width:60px">單位</th>
            <th style="width:60px">數量</th>
            <th style="width:80px">單價</th>
            <th style="width:70px">折扣</th>
            <th style="width:90px">小計</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-center"><input type="checkbox" class="row-chk"></td>
            <td><input type="text" class="form-control form-control-sm item-name"></td>
            <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
            <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
            <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" pattern="\d*" inputmode="decimal"></td>
            <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
            <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
            <td class="text-end fw-bold item-subtotal">0</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ===== 金額統計 ===== -->
    <div class="row g-3 mt-3 small">
      <div class="col-md-4">
        <table class="table table-bordered table-sm">
          <tbody>
            <tr>
              <th class="bg-light">未稅小計</th>
              <td class="text-end" id="subtotal">NT$ 0</td>
            </tr>
            <tr>
              <th class="bg-light">稅額 5%</th>
              <td class="text-end" id="tax">NT$ 0</td>
            </tr>
            <tr>
              <th class="bg-light">含稅合計</th>
              <td class="text-end fw-bold" id="total">NT$ 0</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-md-8">
        <h6>備註 / 條款</h6>
        <textarea class="form-control notes-area terms-box" id="notes" rows="4">
1. 客戶簽章後即視為訂單確認。
2. 執行時間以貴公司交付款項後，為開始起算時間。
3. 以上方案.採一次性。
        </textarea>
      </div>
    </div>

    <!-- ===== 銀行匯款資訊 ===== -->
    <div class="mt-4 small">
      <h6>付款方式</h6>
      <p class="mb-0">
        國泰世華銀行 – 中和分行 (013)<br>
        戶名：程云行銷顧問有限公司<br>
        帳號：045-03-501134-3
      </p>
    </div>

    <div class="text-end small mt-5">
      產生日期：<span id="generatedAt"></span> | 程云行銷顧問有限公司
    </div>
  </div>

  <!-- ===== Bootstrap JS & Icons ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <!-- jQuery, colResizable & html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/colResizable/1.6/colResizable-1.6.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
  $(function(){
    if ($.fn.colResizable) {
      $('#itemTable').colResizable({liveDrag:true, minWidth:40});
    }
  });
  </script>
<script>
/* ========= 工具函式 ========= */
function numClean(v){
  if(typeof v !== 'string') v = String(v ?? '');
  v = v.replace(/,/g,'').replace(/[^\d.-]/g,'');
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}
function fmt(n){
  return (+n || 0).toLocaleString();
}

/* ========= 動態列操作 ========= */
function addRow(){
  const tbody = document.querySelector('#itemTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="text-center"><input type="checkbox" class="row-chk"></td>
    <td><input type="text" class="form-control form-control-sm item-name"></td>
    <td><textarea class="form-control form-control-sm item-desc" rows="1"></textarea></td>
    <td><input type="text" class="form-control form-control-sm item-unit" value="組"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-price" value="0" inputmode="decimal"></td>
    <td><input type="text" class="form-control form-control-sm item-discount" value="0" inputmode="decimal"></td>
    <td class="text-end fw-bold item-subtotal">0</td>
  `;
  tbody.appendChild(tr);
  updateRowSubtotal(tr);
  calculateTotal();
}

function duplicateRow(){
  const tbody = document.querySelector('#itemTable tbody');
  [...tbody.querySelectorAll('tr')].forEach(row=>{
    if(row.querySelector('.row-chk').checked){
      const clone = row.cloneNode(true);
      clone.querySelector('.row-chk').checked = false;
      tbody.appendChild(clone);
      updateRowSubtotal(clone);
    }
  });
  calculateTotal();
}

function deleteSelected(){
  const tbody = document.querySelector('#itemTable tbody');
  [...tbody.querySelectorAll('tr')].forEach(row=>{
    if(row.querySelector('.row-chk').checked){
      row.remove();
    }
  });
  if(!tbody.querySelector('tr')) addRow(); // 至少保留一列
  calculateTotal();
}

function toggleAll(source){
  const checked = source.checked;
  document.querySelectorAll('#itemTable tbody .row-chk').forEach(cb=>cb.checked = checked);
}

/* ========= 計算 ========= */
function updateRowSubtotal(row){
  const qty = numClean(row.querySelector('.item-qty')?.value ?? 0);
  const price = numClean(row.querySelector('.item-price')?.value ?? 0);
  const discount = numClean(row.querySelector('.item-discount')?.value ?? 0);
  const subtotal = Math.max(qty*price - discount, 0);
  row.querySelector('.item-subtotal').textContent = fmt(subtotal);
  return subtotal;
}

function calculateTotal(){
  const rows = document.querySelectorAll('#itemTable tbody tr');
  let subtotal = 0;
  rows.forEach(r=> subtotal += updateRowSubtotal(r));
  const taxRate = numClean(document.getElementById('taxRate').value);
  const tax = subtotal * (taxRate/100);
  const total = subtotal + tax;
  document.getElementById('subtotal').textContent = 'NT$ ' + fmt(subtotal);
  document.getElementById('tax').textContent = 'NT$ ' + fmt(tax);
  document.getElementById('total').textContent = 'NT$ ' + fmt(total);
}

/* ========= 欄寬調整 ========= */
function adjustColWidth(amount){
  const root = document.documentElement;
  const cur = parseInt(getComputedStyle(root).getPropertyValue('--col-name-width') || '180',10);
  let next = cur + amount;
  if(next < 100) next = 100;
  if(next > 400) next = 400;
  root.style.setProperty('--col-name-width', next+'px');
  const slider = document.getElementById('colWidthSlider');
  if(slider) slider.value = next;
}

/* ========= 暫存 / 載入 ========= */
function collectMeta(){
  return {
    quoteDate: document.getElementById('quoteDate').value,
    quoteNo: document.getElementById('quoteNo').value,
    eventName: document.getElementById('eventName').value,
    eventDate: document.getElementById('eventDate').value,
    eventTime: document.getElementById('eventTime').value,
    venue: document.getElementById('venue').value,
    account: document.getElementById('account').value,
    taxRate: document.getElementById('taxRate').value,
    paymentTerm: document.getElementById('paymentTerm').value,
    validDays: document.getElementById('validDays').value,
    clientCompany: document.getElementById('clientCompany').value,
    clientContact: document.getElementById('clientContact').value,
    clientPhone: document.getElementById('clientPhone').value,
    clientAddress: document.getElementById('clientAddress').value,
    clientFax: document.getElementById('clientFax').value,
    clientMobile: document.getElementById('clientMobile').value,
    clientEmail: document.getElementById('clientEmail').value,
    vendorCompany: document.getElementById('vendorCompany').value,
    vendorTax: document.getElementById('vendorTax').value,
    vendorContact: document.getElementById('vendorContact').value,
    vendorEmail: document.getElementById('vendorEmail').value,
    vendorPhone: document.getElementById('vendorPhone').value,
    vendorAddress: document.getElementById('vendorAddress').value,
    notes: document.getElementById('notes').value
  };
}

function applyMeta(m){
  if(!m) return;
  for(const k of Object.keys(m)){
    const el = document.getElementById(k);
    if(el) el.value = m[k];
  }
}

function collectItems(){
  const items = [];
  document.querySelectorAll('#itemTable tbody tr').forEach(tr=>{
    items.push({
      name: tr.querySelector('.item-name').value,
      desc: tr.querySelector('.item-desc').value,
      unit: tr.querySelector('.item-unit').value,
      qty: tr.querySelector('.item-qty').value,
      price: tr.querySelector('.item-price').value,
      discount: tr.querySelector('.item-discount').value
    });
  });
  return items;
}

function populateItems(items){
  const tbody = document.querySelector('#itemTable tbody');
  tbody.innerHTML='';
  (items||[]).forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center"><input type="checkbox" class="row-chk"></td>
      <td><input type="text" class="form-control form-control-sm item-name" value="${it.name||''}"></td>
      <td><textarea class="form-control form-control-sm item-desc" rows="1">${it.desc||''}</textarea></td>
      <td><input type="text" class="form-control form-control-sm item-unit" value="${it.unit||'組'}"></td>
      <td><input type="number" class="form-control form-control-sm item-qty" value="${it.qty||1}" min="1" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-price" value="${it.price||0}" inputmode="decimal"></td>
      <td><input type="text" class="form-control form-control-sm item-discount" value="${it.discount||0}" inputmode="decimal"></td>
      <td class="text-end fw-bold item-subtotal">0</td>`;
    tbody.appendChild(tr);
    updateRowSubtotal(tr);
  });
  calculateTotal();
}

function saveDraft(){
  const data = {meta:collectMeta(),items:collectItems()};
  localStorage.setItem('quotationDraft', JSON.stringify(data));
  alert('已暫存資料');
}

function loadDraft(){
  const raw = localStorage.getItem('quotationDraft');
  if(!raw){ alert('無暫存資料'); return; }
  try{
    const data = JSON.parse(raw);
    applyMeta(data.meta);
    populateItems(data.items);
    alert('已載入暫存資料');
  }catch(err){
    alert('暫存資料格式不正確');
  }
}

function clearDraft(){
  if(confirm('確認清除暫存？')){
    localStorage.removeItem('quotationDraft');
    alert('已清除暫存資料');
  }
}

/* ========= 匯入 ========= */
function importFile(evt){
  const file = evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    const txt = e.target.result;
    if(file.name.endsWith('.json')){
      try{
        const data = JSON.parse(txt);
        applyMeta(data.meta);
        populateItems(data.items);
        alert('已匯入 JSON');
      }catch(err){
        alert('JSON 格式錯誤');
      }
    }else if(file.name.endsWith('.csv')){
      importCSV(txt);
    }else{
      alert('不支援的檔案類型');
    }
  };
  reader.readAsText(file);
  evt.target.value='';
}

function importCSV(csvText){
  const lines = csvText.trim().split(/\r?\n/);
  if(lines.length<2){ alert('CSV 無資料'); return; }
  const header = lines[0].split(',');
  const items=[];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(',');
    const it={};
    header.forEach((h,idx)=> it[h.trim()] = cols[idx] ? cols[idx].trim() : '');
    items.push({
      name:it.name||'',
      desc:it.desc||'',
      unit:it.unit||'',
      qty:it.qty||1,
      price:it.price||0,
      discount:it.discount||0
    });
  }
  populateItems(items);
  alert('已匯入 CSV');
}

/* ========= PDF ========= */
function exportPDF(){
  // 更新產生時間
  document.getElementById('generatedAt').textContent = new Date().toLocaleString();
  const element = document.querySelector('.container-fluid');
  const opt = {
    // 設成 0 移除 html2pdf 預設 0.5‑inch 頁邊距
    margin:       0,
    filename:     (document.getElementById('quoteNo').value || 'quotation') + '.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  {
      scale: 2,
      useCORS: true,
      // 保證擷取完整寬度，避免 canvas 截圖時產生額外留白
      scrollY: 0
    },
    jsPDF:        { unit:'in', format:'a4', orientation:'portrait' },
    // 避免標題與表格被切到新頁
    pagebreak:    { mode: ['avoid-all'] }
  };
  html2pdf().set(opt).from(element).save();
}

/* ========= 模板 ========= */
const TEMPLATE_STORE_KEY = 'quoteTemplates';
if(!localStorage.getItem(TEMPLATE_STORE_KEY)){
  localStorage.setItem(TEMPLATE_STORE_KEY, JSON.stringify([
    {name:'網站建置',desc:'五頁靜態官網',unit:'案',qty:1,price:30000,discount:0},
    {name:'維護費',desc:'一年維護服務',unit:'年',qty:1,price:12000,discount:0}
  ]));
}
function applyTemplate(){
  const items = JSON.parse(localStorage.getItem(TEMPLATE_STORE_KEY)||'[]');
  if(!items.length){ alert('尚未建立模板'); return; }
  populateItems(items);
}

/* ========= 事件綁定 ========= */
document.getElementById('itemTable').addEventListener('input', e=>{
  if(['item-qty','item-price','item-discount'].some(cls=> e.target.classList.contains(cls))){
    updateRowSubtotal(e.target.closest('tr'));
    calculateTotal();
  }
});
document.getElementById('itemTable').addEventListener('blur', e=>{
  if(['item-price','item-discount'].some(cls=> e.target.classList.contains(cls))){
    e.target.value = fmt(numClean(e.target.value));
  }
}, true);

document.getElementById('colWidthSlider').addEventListener('input', e=>{
  document.documentElement.style.setProperty('--col-name-width', e.target.value+'px');
});

document.getElementById('taxRate').addEventListener('input', calculateTotal);

/* ========= 初始化 ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  // 設定初始欄寬 CSS 變數
  document.documentElement.style.setProperty('--col-name-width','180px');
  document.getElementById('generatedAt').textContent = new Date().toLocaleString();
  calculateTotal();
});
</script>
</body>
</html>